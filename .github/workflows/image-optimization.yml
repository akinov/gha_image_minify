name: ç”»åƒæœ€é©åŒ–ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: write
  pull-requests: write

jobs:
  image-optimization:
    name: ç”»åƒã®æœ€é©åŒ–ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # ã™ã¹ã¦ã®å±¥æ­´ã‚’å–å¾—ã—ã¦å·®åˆ†ã®ç¢ºèªã«ä½¿ç”¨

      - name: å¿…è¦ãªãƒ„ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          sudo apt-get update
          sudo apt-get install -y jpegoptim pngquant

      - name: PRã§å¤‰æ›´ã•ã‚ŒãŸç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®å–å¾—
        id: changed-files
        run: |
          # PRã®å·®åˆ†ã‹ã‚‰ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªã‚¹ãƒˆã‚’ä½œæˆ
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}

          CHANGED_IMAGES=$(git diff --name-only $BASE_SHA $HEAD_SHA | grep -E '\.jpe?g$|\.png$' || true)

          if [ -z "$CHANGED_IMAGES" ]; then
            echo "å¤‰æ›´ã•ã‚ŒãŸç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"
            echo "has_images=false" >> $GITHUB_OUTPUT
          else
            echo "å¤‰æ›´ã•ã‚ŒãŸç”»åƒãƒ•ã‚¡ã‚¤ãƒ«: $CHANGED_IMAGES"
            echo "$CHANGED_IMAGES" > changed_images.txt
            echo "has_images=true" >> $GITHUB_OUTPUT
          fi

      - name: ç”»åƒåœ§ç¸®ãƒã‚§ãƒƒã‚¯
        if: steps.changed-files.outputs.has_images == 'true'
        id: compression-check
        run: |
          echo "| ãƒ•ã‚¡ã‚¤ãƒ« | ç¾åœ¨ã®ã‚µã‚¤ã‚º | åœ§ç¸®å¾Œã®ã‚µã‚¤ã‚º | å‰Šæ¸›ç‡ |" > report.md
          echo "|---------|------------|--------------|-------|" >> report.md

          FOUND_ISSUE=false
          OPTIMIZED_FILES=false
          mkdir -p optimized_images

          while IFS= read -r file; do
            if [[ -f "$file" ]]; then
              # å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’å–å¾—
              ORIGINAL_SIZE=$(stat -c%s "$file")
              ORIGINAL_SIZE_HUMAN=$(numfmt --to=iec --suffix=B $ORIGINAL_SIZE)

              # ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ã«åŸºã¥ã„ã¦åœ§ç¸®ã‚’å®Ÿè¡Œ
              if [[ "$file" =~ \.jpe?g$ ]]; then
                # JPEGãƒ•ã‚¡ã‚¤ãƒ«ã®åœ§ç¸®
                cp "$file" "${file}.tmp"
                jpegoptim --max=80 --strip-all "${file}.tmp" --stdout > "optimized_images/$(basename "$file")"
                COMPRESSED_SIZE=$(stat -c%s "optimized_images/$(basename "$file")")
              elif [[ "$file" =~ \.png$ ]]; then
                # PNGãƒ•ã‚¡ã‚¤ãƒ«ã®åœ§ç¸®
                pngquant --quality=65-80 "$file" --output "optimized_images/$(basename "$file")" --force
                COMPRESSED_SIZE=$(stat -c%s "optimized_images/$(basename "$file")")
              fi

              COMPRESSED_SIZE_HUMAN=$(numfmt --to=iec --suffix=B $COMPRESSED_SIZE)

              # å‰Šæ¸›ç‡ã®è¨ˆç®— (%)
              REDUCTION=$(awk "BEGIN {print 100 - ($COMPRESSED_SIZE / $ORIGINAL_SIZE * 100)}")
              REDUCTION_ROUNDED=$(printf "%.1f" $REDUCTION)

              echo "ãƒ•ã‚¡ã‚¤ãƒ«: $file"
              echo "å…ƒã®ã‚µã‚¤ã‚º: $ORIGINAL_SIZE_HUMAN"
              echo "åœ§ç¸®å¾Œã®ã‚µã‚¤ã‚º: $COMPRESSED_SIZE_HUMAN"
              echo "å‰Šæ¸›ç‡: $REDUCTION_ROUNDED%"

              # å…ƒã®ã‚µã‚¤ã‚ºã®70%ä»¥ä¸‹ã«ãªã‚‹å ´åˆã¯ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
              if (( $(echo "$REDUCTION > 30" | bc -l) )); then
                echo "| $file | $ORIGINAL_SIZE_HUMAN | $COMPRESSED_SIZE_HUMAN | $REDUCTION_ROUNDED% |" >> report.md
                FOUND_ISSUE=true
                OPTIMIZED_FILES=true
                # åœ§ç¸®ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚ªãƒªã‚¸ãƒŠãƒ«ã®å ´æ‰€ã«ä¿å­˜
                mkdir -p $(dirname "$file")
                cp "optimized_images/$(basename "$file")" "$file"
              fi

              # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤
              rm -f "${file}.tmp"
            fi
          done < changed_images.txt

          if [ "$FOUND_ISSUE" = true ]; then
            echo "optimization_required=true" >> $GITHUB_OUTPUT

            if [ "$OPTIMIZED_FILES" = true ]; then
              echo "optimized_images=true" >> $GITHUB_OUTPUT
            else
              echo "optimized_images=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "optimization_required=false" >> $GITHUB_OUTPUT
            echo "åœ§ç¸®ãŒå¿…è¦ãªç”»åƒã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"
          fi

      - name: æœ€é©åŒ–ã—ãŸç”»åƒã®ãƒ—ãƒƒã‚·ãƒ¥ã¨PRä½œæˆ
        if: steps.compression-check.outputs.optimized_images == 'true'
        id: create-pr
        run: |
          # ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—
          CURRENT_BRANCH="${{ github.head_ref }}"

          # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ç”Ÿæˆ
          TIMESTAMP=$(date +%Y%m%d%H%M%S)

          # åœ§ç¸®ã—ãŸç”»åƒã‚’ã‚³ãƒŸãƒƒãƒˆã™ã‚‹ãƒ–ãƒ©ãƒ³ãƒåã‚’ä½œæˆï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å«ã‚€ï¼‰
          OPTIMIZE_BRANCH="${CURRENT_BRANCH}-optimize-image-${TIMESTAMP}"

          # Gitè¨­å®š
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          # æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
          git checkout -b $OPTIMIZE_BRANCH

          # å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆï¼ˆåœ§ç¸®ã—ãŸç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’è¿½åŠ ï¼‰
          while IFS= read -r file; do
            if [[ -f "$file" ]]; then
              # å…ƒã®ã‚µã‚¤ã‚ºã‚’å–å¾—
              ORIGINAL_SIZE=$(stat -c%s "$file")

              # å¯¾å¿œã™ã‚‹æœ€é©åŒ–ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µã‚¤ã‚ºã‚’å–å¾—
              COMPRESSED_SIZE=$(stat -c%s "optimized_images/$(basename "$file")")

              # å‰Šæ¸›ç‡ã®è¨ˆç®— (%)
              REDUCTION=$(awk "BEGIN {print 100 - ($COMPRESSED_SIZE / $ORIGINAL_SIZE * 100)}")

              # å…ƒã®ã‚µã‚¤ã‚ºã®70%ä»¥ä¸‹ã«ãªã‚‹å ´åˆã®ã¿è¿½åŠ 
              if (( $(echo "$REDUCTION > 30" | bc -l) )); then
                git add "$file"
              fi
            fi
          done < changed_images.txt

          # ã‚³ãƒŸãƒƒãƒˆã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã‹ç¢ºèª
          if [ -n "$(git diff --cached --name-only)" ]; then
            git commit -m "ğŸ—œï¸ ç”»åƒã‚’æœ€é©åŒ–ï¼ˆåœ§ç¸®ç‡70%ä»¥ä¸‹ï¼‰"

            # ãƒªãƒ¢ãƒ¼ãƒˆã«ãƒ—ãƒƒã‚·ãƒ¥
            git push origin $OPTIMIZE_BRANCH

            # PRä½œæˆ
            PR_URL=$(gh pr create --base $CURRENT_BRANCH --head $OPTIMIZE_BRANCH --title "ğŸ—œï¸ ç”»åƒã®æœ€é©åŒ–ï¼ˆåœ§ç¸®ç‡70%ä»¥ä¸‹ï¼‰" --body "ã“ã®PRã¯è‡ªå‹•çš„ã«ä½œæˆã•ã‚Œã¾ã—ãŸã€‚åœ§ç¸®ç‡ãŒ70%ä»¥ä¸‹ã«ãªã‚‹ç”»åƒãŒæ¤œå‡ºã•ã‚ŒãŸãŸã‚ã€æœ€é©åŒ–ã•ã‚ŒãŸç”»åƒã«ç½®ãæ›ãˆã¦ã„ã¾ã™ã€‚")

            # PR_URLã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¦ã‚¹ãƒ†ãƒƒãƒ—é–“ã§å…±æœ‰
            echo "$PR_URL" > pr_url.txt
            echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          else
            echo "ã‚³ãƒŸãƒƒãƒˆã™ã¹ãæœ€é©åŒ–ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
        if: steps.compression-check.outputs.optimization_required == 'true'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('report.md', 'utf8');

            let body = `## ç”»åƒåœ§ç¸®ã®æœ€é©åŒ–ãŒå¿…è¦ã§ã™ ğŸ–¼ï¸\n\n`;
            body += `ä»¥ä¸‹ã®ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€åœ§ç¸®ã«ã‚ˆã£ã¦å¤§å¹…ã«ã‚µã‚¤ã‚ºã‚’å‰Šæ¸›ã§ãã¾ã™:\n\n`;
            body += `${report}\n\n`;

            if ('${{ steps.create-pr.outputs.pr_url }}') {
              body += `### æœ€é©åŒ–ã•ã‚ŒãŸç”»åƒã®PR\n\n`;
              body += `æœ€é©åŒ–ã•ã‚ŒãŸç”»åƒã‚’å«ã‚€PRãŒè‡ªå‹•çš„ã«ä½œæˆã•ã‚Œã¾ã—ãŸ:\n`;
              body += `ğŸ”— [${{ steps.create-pr.outputs.pr_url }}](${{ steps.create-pr.outputs.pr_url }})\n\n`;
              body += `ã“ã®PRã‚’ãƒãƒ¼ã‚¸ã™ã‚‹ã“ã¨ã§ã€æœ€é©åŒ–ã•ã‚ŒãŸç”»åƒã«ç½®ãæ›ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\n\n`;
            } else {
              body += `### ãƒ­ãƒ¼ã‚«ãƒ«ã§åœ§ç¸®ã™ã‚‹ã«ã¯:\n\n`;
              body += `JPEGãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆ:\n\`\`\`bash\njpegoptim --max=80 --strip-all path/to/image.jpg\n\`\`\`\n\n`;
              body += `PNGãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆ:\n\`\`\`bash\npngquant --quality=65-80 path/to/image.png --output path/to/image-compressed.png\n\`\`\`\n\n`;
              body += `æœ€é©åŒ–ã•ã‚ŒãŸç”»åƒã‚’è¿½åŠ ã—ã¦PRã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚\n`;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®çŠ¶æ…‹ã‚’è¨­å®š
        if: steps.compression-check.outputs.optimization_required == 'true'
        run: exit 1
