name: AI Code Review
on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read
  models: read

jobs:
  code-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    env:
      REVIEW_PROMPT: |
        ä»¥ä¸‹ã®Pull Requestã®å·®åˆ†ã‚’ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚

        ã‚³ãƒ¼ãƒ‰ã®å“è³ªã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã€ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«é–¢ã—ã¦ä»¥ä¸‹ã®è¦³ç‚¹ã§è©•ä¾¡ã—ã¦ãã ã•ã„ï¼š

        1. ã‚³ãƒ¼ãƒ‰ã®å“è³ªãƒ»å¯èª­æ€§
        2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®å•é¡Œ
        3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã¸ã®å½±éŸ¿
        4. ãƒã‚°ã®å¯èƒ½æ€§
        5. ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã®éµå®ˆ

        æ”¹å–„ææ¡ˆãŒã‚ã‚‹å ´åˆã¯ã€å…·ä½“çš„ãªä¿®æ­£æ–¹æ³•ã‚‚å«ã‚ã¦èª¬æ˜Žã—ã¦ãã ã•ã„ã€‚

        ä»¥ä¸‹ãŒã‚³ãƒ¼ãƒ‰ã®å·®åˆ†ã§ã™ï¼š
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: get-diff
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr diff ${{ github.event.number }} > pr_diff.txt
          
          if [ ! -s pr_diff.txt ]; then
            echo "No changes found in PR"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          DIFF_CONTENT=$(cat pr_diff.txt | head -c 8000)
          {
            echo "diff<<EOF"
            echo "$DIFF_CONTENT"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: AI Code Review
        id: code-review
        if: steps.get-diff.outputs.has_changes == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DIFF_CONTENT='${{ steps.get-diff.outputs.diff }}'
          
          PROMPT_TEXT="${REVIEW_PROMPT}
          $DIFF_CONTENT"
          
          PROMPT=$(echo "$PROMPT_TEXT" | jq -Rs .)

          RAW_RESPONSE=$(curl -s "https://models.github.ai/inference/chat/completions" \
             -H "Content-Type: application/json" \
             -H "Authorization: Bearer $GITHUB_TOKEN" \
             -d "{
              \"messages\": [
                  {
                     \"role\": \"user\",
                     \"content\": $PROMPT
                  }
               ],
               \"model\": \"anthropic/claude-3.5-sonnet\"
            }")

          echo "$RAW_RESPONSE" > raw_response.json

          CONTENT=$(echo "$RAW_RESPONSE" | jq -r '.choices[0].message.content')

          echo "$CONTENT" > review_response.txt

          {
            echo "review<<EOF"
            echo "$CONTENT"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          {
            echo "raw_response<<EOF"
            echo "$RAW_RESPONSE"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Comment on PR
        if: steps.get-diff.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const review = \`## ðŸ¤– AI Code Review by Claude Sonnet 4

            \${{ steps.code-review.outputs.review }}

            ---
            *This review was automatically generated by Claude Sonnet 4*\`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: review
            });

      - name: Output review as log
        if: steps.get-diff.outputs.has_changes == 'true'
        run: |
          echo "=========================================="
          echo "AI Code Review by Claude Sonnet 4:"
          echo "=========================================="
          echo "${{ steps.code-review.outputs.review }}"
          echo "=========================================="
