name: AI Code Review
on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read
  models: read

jobs:
  code-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    env:
      REVIEW_PROMPT: |
        以下のPull Requestの差分をコードレビューしてください。

        コードの品質、セキュリティ、パフォーマンス、ベストプラクティスに関して以下の観点で評価してください：

        1. コードの品質・可読性
        2. セキュリティ上の問題
        3. パフォーマンスへの影響
        4. バグの可能性
        5. ベストプラクティスの遵守

        改善提案がある場合は、具体的な修正方法も含めて説明してください。

        以下がコードの差分です：
    steps:
      - name: Debug workflow info
        run: |
          echo "=========================================="
          echo "DEBUG: Workflow started"
          echo "=========================================="
          echo "Event: ${{ github.event_name }}"
          echo "PR Number: ${{ github.event.number }}"
          echo "Repository: ${{ github.repository }}"
          echo "Actor: ${{ github.actor }}"
          echo "Ref: ${{ github.ref }}"
          echo "SHA: ${{ github.sha }}"
          echo "=========================================="

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: get-diff
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=========================================="
          echo "DEBUG: Getting PR diff for PR #${{ github.event.number }}"
          echo "=========================================="
          
          gh pr diff ${{ github.event.number }} > pr_diff.txt
          
          echo "DEBUG: Checking if diff file exists and has content..."
          ls -la pr_diff.txt || echo "DEBUG: pr_diff.txt not found"
          
          if [ ! -s pr_diff.txt ]; then
            echo "DEBUG: No changes found in PR"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "DEBUG: Changes found, setting has_changes=true"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          echo "DEBUG: Reading diff content (first 8000 chars)..."
          DIFF_CONTENT=$(cat pr_diff.txt | head -c 8000)
          echo "DEBUG: Diff content length: $(echo -n "$DIFF_CONTENT" | wc -c) characters"
          
          {
            echo "diff<<EOF"
            echo "$DIFF_CONTENT"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          echo "DEBUG: Diff content has been set to GITHUB_OUTPUT"

      - name: List Available Models
        if: steps.get-diff.outputs.has_changes == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=========================================="
          echo "DEBUG: Listing available models from GitHub Models API"
          echo "=========================================="
          
          echo "DEBUG: Making API request to list models..."
          MODELS_RESPONSE=$(curl -s " https://models.github.ai/catalog/models" \
             -H "Accept: application/vnd.github+json" \
             -H "Authorization: Bearer $GITHUB_TOKEN" \
             -H "X-GitHub-Api-Version: 2022-11-28")
          
          echo "DEBUG: Models API response received"

          echo "DEBUG: Raw models response:"
          echo "$MODELS_RESPONSE"
          echo "=========================================="
