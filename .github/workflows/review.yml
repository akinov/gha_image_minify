name: AI Code Review
on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read
  models: read

jobs:
  code-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    env:
      REVIEW_PROMPT: |
        ä»¥ä¸‹ã®Pull Requestã®å·®åˆ†ã‚’ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚

        ã‚³ãƒ¼ãƒ‰ã®å“è³ªã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã€ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«é–¢ã—ã¦ä»¥ä¸‹ã®è¦³ç‚¹ã§è©•ä¾¡ã—ã¦ãã ã•ã„ï¼š

        1. ã‚³ãƒ¼ãƒ‰ã®å“è³ªãƒ»å¯èª­æ€§
        2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®å•é¡Œ
        3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã¸ã®å½±éŸ¿
        4. ãƒã‚°ã®å¯èƒ½æ€§
        5. ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã®éµå®ˆ

        æ”¹å–„ææ¡ˆãŒã‚ã‚‹å ´åˆã¯ã€å…·ä½“çš„ãªä¿®æ­£æ–¹æ³•ã‚‚å«ã‚ã¦èª¬æ˜Žã—ã¦ãã ã•ã„ã€‚

        ä»¥ä¸‹ãŒã‚³ãƒ¼ãƒ‰ã®å·®åˆ†ã§ã™ï¼š
    steps:
      - name: Debug workflow info
        run: |
          echo "=========================================="
          echo "DEBUG: Workflow started"
          echo "=========================================="
          echo "Event: ${{ github.event_name }}"
          echo "PR Number: ${{ github.event.number }}"
          echo "Repository: ${{ github.repository }}"
          echo "Actor: ${{ github.actor }}"
          echo "Ref: ${{ github.ref }}"
          echo "SHA: ${{ github.sha }}"
          echo "=========================================="

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: get-diff
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=========================================="
          echo "DEBUG: Getting PR diff for PR #${{ github.event.number }}"
          echo "=========================================="
          
          gh pr diff ${{ github.event.number }} > pr_diff.txt
          
          echo "DEBUG: Checking if diff file exists and has content..."
          ls -la pr_diff.txt || echo "DEBUG: pr_diff.txt not found"
          
          if [ ! -s pr_diff.txt ]; then
            echo "DEBUG: No changes found in PR"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "DEBUG: Changes found, setting has_changes=true"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          echo "DEBUG: Reading diff content (first 8000 chars)..."
          DIFF_CONTENT=$(cat pr_diff.txt | head -c 8000)
          echo "DEBUG: Diff content length: $(echo -n "$DIFF_CONTENT" | wc -c) characters"
          
          {
            echo "diff<<EOF"
            echo "$DIFF_CONTENT"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          echo "DEBUG: Diff content has been set to GITHUB_OUTPUT"

      - name: AI Code Review
        id: code-review
        if: steps.get-diff.outputs.has_changes == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=========================================="
          echo "DEBUG: Starting AI Code Review"
          echo "=========================================="
          
          # GitHub Actionsã®å‡ºåŠ›ã‚’ãƒ•ã‚¡ã‚¤ãƒ«çµŒç”±ã§å®‰å…¨ã«å–å¾—
          echo '${{ steps.get-diff.outputs.diff }}' > diff_content.txt
          echo "DEBUG: Diff content saved to file"
          echo "DEBUG: Retrieved diff content length: $(wc -c < diff_content.txt) characters"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ã‚­ã‚¹ãƒˆã‚’ä½œæˆ
          echo "${REVIEW_PROMPT}" > prompt.txt
          echo "" >> prompt.txt
          cat diff_content.txt >> prompt.txt
          
          echo "DEBUG: Creating JSON prompt..."
          PROMPT=$(cat prompt.txt | jq -Rs .)
          echo "DEBUG: JSON prompt created successfully"
          
          echo "DEBUG: Making API request to GitHub Models..."
          RAW_RESPONSE=$(curl -s "https://models.github.ai/inference/chat/completions" \
             -H "Content-Type: application/json" \
             -H "Authorization: Bearer $GITHUB_TOKEN" \
             -d "{
              \"messages\": [
                  {
                     \"role\": \"user\",
                     \"content\": $PROMPT
                  }
               ],
               \"model\": \"anthropic/claude-3.5-sonnet\"
            }")

          echo "DEBUG: API response received"
          echo "$RAW_RESPONSE" > raw_response.json
          echo "DEBUG: Raw response saved to raw_response.json"

          echo "DEBUG: Extracting content from response..."
          CONTENT=$(echo "$RAW_RESPONSE" | jq -r '.choices[0].message.content')
          
          if [ "$CONTENT" = "null" ] || [ -z "$CONTENT" ]; then
            echo "DEBUG: ERROR - No content received from API"
            echo "DEBUG: Raw response: $RAW_RESPONSE"
            exit 1
          fi
          
          echo "DEBUG: Content extracted successfully, length: $(echo -n "$CONTENT" | wc -c) characters"
          echo "$CONTENT" > review_response.txt

          {
            echo "review<<EOF"
            echo "$CONTENT"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          {
            echo "raw_response<<EOF"
            echo "$RAW_RESPONSE"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          echo "DEBUG: Review content set to GITHUB_OUTPUT"

      - name: Comment on PR
        if: steps.get-diff.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            console.log('DEBUG: Starting PR comment creation...');
            
            const review = \`## ðŸ¤– AI Code Review by Claude Sonnet 4

            \${{ steps.code-review.outputs.review }}

            ---
            *This review was automatically generated by Claude Sonnet 4*\`;

            console.log('DEBUG: Review content length:', review.length);
            console.log('DEBUG: Creating comment on PR...');

            try {
              const result = await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: review
              });
              console.log('DEBUG: Comment created successfully, ID:', result.data.id);
            } catch (error) {
              console.log('DEBUG: Error creating comment:', error.message);
              throw error;
            }

      - name: Output review as log
        if: steps.get-diff.outputs.has_changes == 'true'
        run: |
          echo "=========================================="
          echo "DEBUG: Final review output"
          echo "=========================================="
          echo "AI Code Review by Claude Sonnet 4:"
          echo "=========================================="
          echo "${{ steps.code-review.outputs.review }}"
          echo "=========================================="
          echo "DEBUG: Review output completed"
