name: ç”»åƒåœ§ç¸®ãƒã‚§ãƒƒã‚«ãƒ¼

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  check-image-optimization:
    name: ç”»åƒã®æœ€é©åŒ–ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # ã™ã¹ã¦ã®å±¥æ­´ã‚’å–å¾—ã—ã¦å·®åˆ†ã®ç¢ºèªã«ä½¿ç”¨

      - name: ç”»åƒåœ§ç¸®PRã®ãƒã‚§ãƒƒã‚¯
        id: check-pr
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: openPRs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              base: context.payload.pull_request.base.ref
            });

            const hasImageOptimizationPR = openPRs.some(pr =>
              pr.title.includes('ç”»åƒåœ§ç¸®') && pr.number !== context.issue.number
            );

            if (hasImageOptimizationPR) {
              console.log('åŒã˜baseãƒ–ãƒ©ãƒ³ãƒã«ç”»åƒåœ§ç¸®ç”¨ã®PRãŒå­˜åœ¨ã™ã‚‹ãŸã‚ã€ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚');
              process.exit(0);
            }

      - name: å¿…è¦ãªãƒ„ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          sudo apt-get update
          sudo apt-get install -y jpegoptim pngquant

      - name: PRã§å¤‰æ›´ã•ã‚ŒãŸç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®å–å¾—
        id: changed-files
        run: |
          # PRã®å·®åˆ†ã‹ã‚‰ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªã‚¹ãƒˆã‚’ä½œæˆ
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}

          CHANGED_IMAGES=$(git diff --name-only $BASE_SHA $HEAD_SHA | grep -E '\.jpe?g$|\.png$' || true)

          if [ -z "$CHANGED_IMAGES" ]; then
            echo "å¤‰æ›´ã•ã‚ŒãŸç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"
            echo "has_images=false" >> $GITHUB_OUTPUT
          else
            echo "å¤‰æ›´ã•ã‚ŒãŸç”»åƒãƒ•ã‚¡ã‚¤ãƒ«: $CHANGED_IMAGES"
            echo "$CHANGED_IMAGES" > changed_images.txt
            echo "has_images=true" >> $GITHUB_OUTPUT
          fi

      - name: ç”»åƒåœ§ç¸®ãƒã‚§ãƒƒã‚¯
        if: steps.changed-files.outputs.has_images == 'true'
        id: compression-check
        run: |
          echo "| ãƒ•ã‚¡ã‚¤ãƒ« | ç¾åœ¨ã®ã‚µã‚¤ã‚º | åœ§ç¸®å¾Œã®ã‚µã‚¤ã‚º | å‰Šæ¸›ç‡ |" > report.md
          echo "|---------|------------|--------------|-------|" >> report.md

          FOUND_ISSUE=false

          while IFS= read -r file; do
            if [[ -f "$file" ]]; then
              # å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’å–å¾—
              ORIGINAL_SIZE=$(stat -c%s "$file")
              ORIGINAL_SIZE_HUMAN=$(numfmt --to=iec --suffix=B $ORIGINAL_SIZE)

              # ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ã«åŸºã¥ã„ã¦åœ§ç¸®ã‚’å®Ÿè¡Œ
              if [[ "$file" =~ \.jpe?g$ ]]; then
                # JPEGãƒ•ã‚¡ã‚¤ãƒ«ã®åœ§ç¸®
                cp "$file" "${file}.tmp"
                jpegoptim --max=80 --strip-all "${file}.tmp" --stdout > "/tmp/compressed.jpg"
                COMPRESSED_SIZE=$(stat -c%s "/tmp/compressed.jpg")
              elif [[ "$file" =~ \.png$ ]]; then
                # PNGãƒ•ã‚¡ã‚¤ãƒ«ã®åœ§ç¸®
                pngquant --quality=65-80 "$file" --output "/tmp/compressed.png" --force
                COMPRESSED_SIZE=$(stat -c%s "/tmp/compressed.png")
              fi

              COMPRESSED_SIZE_HUMAN=$(numfmt --to=iec --suffix=B $COMPRESSED_SIZE)

              # å‰Šæ¸›ç‡ã®è¨ˆç®— (%)
              REDUCTION=$(awk "BEGIN {print 100 - ($COMPRESSED_SIZE / $ORIGINAL_SIZE * 100)}")
              REDUCTION_ROUNDED=$(printf "%.1f" $REDUCTION)

              echo "ãƒ•ã‚¡ã‚¤ãƒ«: $file"
              echo "å…ƒã®ã‚µã‚¤ã‚º: $ORIGINAL_SIZE_HUMAN"
              echo "åœ§ç¸®å¾Œã®ã‚µã‚¤ã‚º: $COMPRESSED_SIZE_HUMAN"
              echo "å‰Šæ¸›ç‡: $REDUCTION_ROUNDED%"

              # å…ƒã®ã‚µã‚¤ã‚ºã®70%ä»¥ä¸‹ã«ãªã‚‹å ´åˆã¯ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
              if (( $(echo "$REDUCTION > 30" | bc -l) )); then
                echo "| $file | $ORIGINAL_SIZE_HUMAN | $COMPRESSED_SIZE_HUMAN | $REDUCTION_ROUNDED% |" >> report.md
                FOUND_ISSUE=true
              fi

              # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤
              rm -f "${file}.tmp" "/tmp/compressed.jpg" "/tmp/compressed.png"
            fi
          done < changed_images.txt

          if [ "$FOUND_ISSUE" = true ]; then
            # åœ§ç¸®å¯èƒ½ãªç”»åƒãŒã‚ã‚‹ãŸã‚CIã‚’ãƒ•ã‚§ã‚¤ãƒ«ã«ã™ã‚‹
            echo "optimization_required=true" >> $GITHUB_OUTPUT

            # ãƒ¬ãƒãƒ¼ãƒˆã®å®Œæˆ
            {
              echo "## ç”»åƒåœ§ç¸®ã®æœ€é©åŒ–ãŒå¿…è¦ã§ã™ ğŸ–¼ï¸"
              echo ""
              echo "ä»¥ä¸‹ã®ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€åœ§ç¸®ã«ã‚ˆã£ã¦å¤§å¹…ã«ã‚µã‚¤ã‚ºã‚’å‰Šæ¸›ã§ãã¾ã™:"
              echo ""
              cat report.md
              echo ""
              echo "### ãƒ­ãƒ¼ã‚«ãƒ«ã§åœ§ç¸®ã™ã‚‹ã«ã¯:"
              echo ""
              echo "JPEGãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆ:"
              echo '```bash'
              echo "jpegoptim --max=80 --strip-all path/to/image.jpg"
              echo '```'
              echo ""
              echo "PNGãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆ:"
              echo '```bash'
              echo "pngquant --quality=65-80 path/to/image.png --output path/to/image-compressed.png"
              echo '```'
              echo ""
              echo "æœ€é©åŒ–ã•ã‚ŒãŸç”»åƒã‚’è¿½åŠ ã—ã¦PRã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚"
            } > comment.md

          else
            echo "optimization_required=false" >> $GITHUB_OUTPUT
            echo "åœ§ç¸®ãŒå¿…è¦ãªç”»åƒã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"
          fi

      - name: PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
        if: steps.compression-check.outputs.optimization_required == 'true'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('comment.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®çŠ¶æ…‹ã‚’è¨­å®š
        if: steps.compression-check.outputs.optimization_required == 'true'
        run: exit 1
