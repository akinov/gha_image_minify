name: AI Code Review with Claude Sonnet 4

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  models: read
  pull-requests: write
  contents: read

jobs:
  code-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: get-diff
        run: |
          # PRã®diffã‚’å–å¾—
          git diff origin/${{ github.base_ref }}..HEAD > pr_diff.txt
          
          # diffãŒç©ºã§ãªã„ã‹ãƒã‚§ãƒƒã‚¯
          if [ ! -s pr_diff.txt ]; then
            echo "No changes found in PR"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          # diffã®å†…å®¹ã‚’outputã«è¨­å®šï¼ˆæ–‡å­—æ•°åˆ¶é™ã‚’è€ƒæ…®ï¼‰
          DIFF_CONTENT=$(cat pr_diff.txt | head -c 8000)
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: AI Code Review
        id: code-review
        if: steps.get-diff.outputs.has_changes == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # PRã®å·®åˆ†ã‚’å¤‰æ•°ã«æ ¼ç´
          DIFF_CONTENT="${{ steps.get-diff.outputs.diff }}"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¿
          cat > prompt.txt << 'EOL'
          ä»¥ä¸‹ã®Pull Requestã®å·®åˆ†ã‚’ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚

          ã‚³ãƒ¼ãƒ‰ã®å“è³ªã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«é–¢ã—ã¦ä»¥ä¸‹ã®è¦³ç‚¹ã§è©•ä¾¡ã—ã¦ãã ã•ã„ï¼š

          1. ã‚³ãƒ¼ãƒ‰ã®å“è³ªãƒ»å¯èª­æ€§
          2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®å•é¡Œ
          3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¸ã®å½±éŸ¿
          4. ãƒã‚°ã®å¯èƒ½æ€§
          5. ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã®éµå®ˆ

          æ”¹å–„ææ¡ˆãŒã‚ã‚‹å ´åˆã¯ã€å…·ä½“çš„ãªä¿®æ­£æ–¹æ³•ã‚‚å«ã‚ã¦èª¬æ˜ã—ã¦ãã ã•ã„ã€‚

          ä»¥ä¸‹ãŒã‚³ãƒ¼ãƒ‰ã®å·®åˆ†ã§ã™ï¼š
          EOL
          
          echo "$DIFF_CONTENT" >> prompt.txt
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æº–å‚™ï¼ˆJSONã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å¯¾å¿œï¼‰
          PROMPT=$(cat prompt.txt | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')

          # Claude Sonnet 4ã§APIå‘¼ã³å‡ºã—
          RAW_RESPONSE=$(curl -s "https://models.github.ai/inference/chat/completions" \
             -H "Content-Type: application/json" \
             -H "Authorization: Bearer $GITHUB_TOKEN" \
             -d "{
              \"messages\": [
                  {
                     \"role\": \"user\",
                     \"content\": \"$PROMPT\"
                  }
               ],
               \"model\": \"anthropic/claude-3.5-sonnet\"
            }")

          # ç”Ÿã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          echo "$RAW_RESPONSE" > raw_response.json

          # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ã‚³ãƒ³ãƒ†ãƒ³ãƒ„éƒ¨åˆ†ã‚’æŠ½å‡º
          CONTENT=$(echo "$RAW_RESPONSE" | jq -r '.choices[0].message.content')

          # æ•´å½¢ã—ãŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          echo "$CONTENT" > review_response.txt

          # GitHub Actionsã®outputã¨ã—ã¦è¨­å®š
          echo "review<<EOF" >> $GITHUB_OUTPUT
          echo "$CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "raw_response<<EOF" >> $GITHUB_OUTPUT
          echo "$RAW_RESPONSE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment on PR
        if: steps.get-diff.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const review = `## ğŸ¤– AI Code Review by Claude Sonnet 4

${{ steps.code-review.outputs.review }}

---
*This review was automatically generated by Claude Sonnet 4*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: review
            });

      - name: Output review as log
        if: steps.get-diff.outputs.has_changes == 'true'
        run: |
          echo "=========================================="
          echo "Claude Sonnet 4ã‹ã‚‰ã®ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼:"
          echo "=========================================="
          echo "${{ steps.code-review.outputs.review }}"
          echo "=========================================="