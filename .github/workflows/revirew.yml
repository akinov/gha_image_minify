name: AI Code Review with Claude Sonnet 4

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  models: read
  pull-requests: write
  contents: read

jobs:
  code-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: get-diff
        run: |
          # PRのdiffを取得
          git diff origin/${{ github.base_ref }}..HEAD > pr_diff.txt
          
          # diffが空でないかチェック
          if [ ! -s pr_diff.txt ]; then
            echo "No changes found in PR"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          # diffの内容をoutputに設定（文字数制限を考慮）
          DIFF_CONTENT=$(cat pr_diff.txt | head -c 8000)
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: AI Code Review
        id: code-review
        if: steps.get-diff.outputs.has_changes == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # PRの差分を変数に格納
          DIFF_CONTENT="${{ steps.get-diff.outputs.diff }}"
          
          # プロンプトをファイルに書き込み
          cat > prompt.txt << 'EOL'
          以下のPull Requestの差分をコードレビューしてください。

          コードの品質、セキュリティ、パフォーマンス、ベストプラクティスに関して以下の観点で評価してください：

          1. コードの品質・可読性
          2. セキュリティ上の問題
          3. パフォーマンスへの影響
          4. バグの可能性
          5. ベストプラクティスの遵守

          改善提案がある場合は、具体的な修正方法も含めて説明してください。

          以下がコードの差分です：
          EOL
          
          echo "$DIFF_CONTENT" >> prompt.txt
          
          # プロンプトを準備（JSONエスケープ対応）
          PROMPT=$(cat prompt.txt | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')

          # Claude Sonnet 4でAPI呼び出し
          RAW_RESPONSE=$(curl -s "https://models.github.ai/inference/chat/completions" \
             -H "Content-Type: application/json" \
             -H "Authorization: Bearer $GITHUB_TOKEN" \
             -d "{
              \"messages\": [
                  {
                     \"role\": \"user\",
                     \"content\": \"$PROMPT\"
                  }
               ],
               \"model\": \"anthropic/claude-3.5-sonnet\"
            }")

          # 生のレスポンスを一時ファイルに保存
          echo "$RAW_RESPONSE" > raw_response.json

          # レスポンスからコンテンツ部分を抽出
          CONTENT=$(echo "$RAW_RESPONSE" | jq -r '.choices[0].message.content')

          # 整形したレスポンスを一時ファイルに保存
          echo "$CONTENT" > review_response.txt

          # GitHub Actionsのoutputとして設定
          echo "review<<EOF" >> $GITHUB_OUTPUT
          echo "$CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "raw_response<<EOF" >> $GITHUB_OUTPUT
          echo "$RAW_RESPONSE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment on PR
        if: steps.get-diff.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const review = `## 🤖 AI Code Review by Claude Sonnet 4

${{ steps.code-review.outputs.review }}

---
*This review was automatically generated by Claude Sonnet 4*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: review
            });

      - name: Output review as log
        if: steps.get-diff.outputs.has_changes == 'true'
        run: |
          echo "=========================================="
          echo "Claude Sonnet 4からのコードレビュー:"
          echo "=========================================="
          echo "${{ steps.code-review.outputs.review }}"
          echo "=========================================="