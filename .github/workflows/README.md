# 画像最適化ワークフロー

このディレクトリには、PR時に画像ファイルの圧縮可能性をチェックし、最適化された画像を含む新しいPRを自動作成するGitHub Actionsワークフローが含まれています。

## ワークフローの概要

`image-optimization.yml`は以下の処理を行います：

1. PRの差分から画像ファイル（JPEG、PNG）を抽出
2. ファイル形式に応じた圧縮ツールを使用して圧縮テスト
   - JPEGの場合: `jpegoptim`
   - PNGの場合: `pngquant`
3. 圧縮前後のファイルサイズを比較
4. 削減率が30%以上になる場合:
   - 最適化された画像を含む新しいPRを自動作成
   - 元のPRにコメントを追加（最適化PRへのリンクを含む）
   - CIをFailにする

## 技術的な詳細

- トリガー条件: PRが作成または更新された時
- 使用環境: ubuntu-latest
- 必要な権限:
  - `contents: write`: リポジトリのコンテンツ変更とブランチ作成
  - `pull-requests: write`: PRの作成とコメント追加
- 使用ツール:
  - jq: JSON処理とPRチェック用
  - jpegoptim: JPEG圧縮用（画像検出時のみインストール）
  - pngquant: PNG圧縮用（画像検出時のみインストール）
  - bc: 計算処理用（画像検出時のみインストール）
  - gh CLI: PR作成用

## 処理フロー

1. **画像最適化PRチェック**: 既存の最適化PRがないかチェック（jqのみ使用）
2. **画像ファイル検出**: PRの差分から画像ファイルを抽出
3. **ツール遅延インストール**: 画像ファイルが見つかった場合のみ最適化ツールをインストール
4. **画像圧縮チェック**: 画像を検出し、圧縮率をチェック
5. **PRの作成**: 圧縮された画像を新ブランチにコミットし、PRを作成
6. **コメントの追加**: 元のPRに、最適化PRへのリンクを含むコメントを追加

## 設定とカスタマイズ

ワークフローの動作は環境変数で制御されます：

```yml
env:
  IMAGE_OPTIMIZATION_TITLE: "画像の最適化"  # PRタイトル
  JPEG_QUALITY: 80                          # JPEG圧縮品質（1-100）
  PNG_QUALITY_RANGE: "65-80"               # PNG圧縮品質範囲
  COMPRESSION_THRESHOLD: 30                # 最適化判定の閾値（削減率%）
```

### 設定例

削減率の閾値を20%に変更する場合：
```yml
env:
  COMPRESSION_THRESHOLD: 20
```

JPEG品質を90に変更する場合：
```yml
env:
  JPEG_QUALITY: 90
```

## パフォーマンス最適化

- **遅延インストール**: 画像ファイルがない場合はjqのみインストール
- **エラーハンドリング**: 最適化ツールの実行失敗時は適切にスキップ
- **条件実行**: 画像ファイルがない場合は重い処理をスキップ
